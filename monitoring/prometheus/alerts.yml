groups:
  - name: microblog-platform
    rules:
      # Service Down Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Service {{ $labels.job }} is down'
          description: 'Service {{ $labels.job }} has been down for more than 1 minute.'

      # High CPU Usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High CPU usage on {{ $labels.instance }}'
          description: 'CPU usage is above 80% for more than 5 minutes.'

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High memory usage on {{ $labels.instance }}'
          description: 'Memory usage is above 85% for more than 5 minutes.'

      # High Disk Usage
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High disk usage on {{ $labels.instance }}'
          description: 'Disk usage is above 85% for more than 5 minutes.'

      # High HTTP Error Rate
      - alert: HighHTTPErrorRate
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100 > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: 'High HTTP error rate'
          description: 'HTTP error rate is above 5% for more than 2 minutes.'

      # High Response Time
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High response time'
          description: '95th percentile response time is above 2 seconds for more than 5 minutes.'

      # Database Connection Issues
      - alert: DatabaseConnectionIssues
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Database connection issues'
          description: 'Database {{ $labels.instance }} is not responding.'

      # Redis Connection Issues
      - alert: RedisConnectionIssues
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Redis connection issues'
          description: 'Redis {{ $labels.instance }} is not responding.'

      # RabbitMQ Connection Issues
      - alert: RabbitMQConnectionIssues
        expr: rabbitmq_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'RabbitMQ connection issues'
          description: 'RabbitMQ {{ $labels.instance }} is not responding.'

      # Elasticsearch Issues
      - alert: ElasticsearchIssues
        expr: elasticsearch_cluster_health_status > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Elasticsearch cluster health issues'
          description: 'Elasticsearch cluster health status is not green.'

      # High JVM Memory Usage (for Java services)
      - alert: HighJVMMemoryUsage
        expr: (jvm_memory_used_bytes / jvm_memory_max_bytes) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High JVM memory usage'
          description: 'JVM memory usage is above 85% for more than 5 minutes.'

      # Node.js Memory Usage
      - alert: HighNodeJSMemoryUsage
        expr: (nodejs_heap_size_used_bytes / nodejs_heap_size_total_bytes) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High Node.js memory usage'
          description: 'Node.js heap memory usage is above 85% for more than 5 minutes.'

      # Process Restart Alert
      - alert: ProcessRestart
        expr: changes(process_start_time_seconds[5m]) > 0
        labels:
          severity: warning
        annotations:
          summary: 'Process restarted'
          description: 'Process {{ $labels.job }} has restarted in the last 5 minutes.'

      # Nginx High Error Rate
      - alert: NginxHighErrorRate
        expr: sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) / sum(rate(nginx_http_requests_total[5m])) * 100 > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: 'Nginx high error rate'
          description: 'Nginx error rate is above 5% for more than 2 minutes.'

      # SSL Certificate Expiry
      - alert: SSLCertificateExpiry
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        labels:
          severity: warning
        annotations:
          summary: 'SSL certificate expiring soon'
          description: 'SSL certificate for {{ $labels.instance }} will expire in less than 30 days.'

      # Service Health Check Failed
      - alert: ServiceHealthCheckFailed
        expr: probe_success == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Service health check failed'
          description: 'Health check for {{ $labels.instance }} is failing.'

      # High Queue Size (RabbitMQ)
      - alert: HighQueueSize
        expr: rabbitmq_queue_messages > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High queue size'
          description: 'Queue {{ $labels.queue }} has more than 1000 messages for more than 5 minutes.'

      # Database Slow Queries
      - alert: DatabaseSlowQueries
        expr: rate(pg_stat_activity_max_tx_duration[5m]) > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Database slow queries detected'
          description: 'Database queries are taking longer than 30 seconds.'

      # High Network Usage
      - alert: HighNetworkUsage
        expr: rate(node_network_receive_bytes_total[5m]) > 1000000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High network usage'
          description: 'Network receive rate is above 1GB/s for more than 5 minutes.'
